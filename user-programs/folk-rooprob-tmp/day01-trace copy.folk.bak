# Day 01: Trace
# Rainbow-colored outlines that leave a fading trail as tags move
return

set this day01-trace

# Convert HSV to RGB (H: 0-360, S: 0-1, V: 0-1) -> {r g b a}
fn hsvToRgb {h s v {a 1.0}} {
    set h [expr {$h / 60.0}]
    set c [expr {$v * $s}]
    set x [expr {$c * (1 - abs(fmod($h, 2) - 1))}]
    set m [expr {$v - $c}]

    set hi [expr {int($h) % 6}]
    switch $hi {
        0 { set rgb [list $c $x 0] }
        1 { set rgb [list $x $c 0] }
        2 { set rgb [list 0 $c $x] }
        3 { set rgb [list 0 $x $c] }
        4 { set rgb [list $x 0 $c] }
        5 { set rgb [list $c 0 $x] }
    }

    lassign $rgb r g b
    return [list [expr {$r + $m}] [expr {$g + $m}] [expr {$b + $m}] $a]
}

# Track tag positions and draw trails
When the clock time is /clockTime/ &\
     tag /tagId/ has quad /quad/ {

    set now [clock milliseconds]

    # Calculate current rainbow color
    set hue [expr {int(fmod($clockTime * 120, 360))}]
    set color [hsvToRgb $hue 1.0 1.0]

    # Display rainbow outline on current tag
    Wish $tagId is outlined $color

    # Store position every 200ms
    set trail [Query! tag $tagId has trail /t/]
    if {[llength $trail] > 0} {
        set existingTrail [dict get [lindex $trail 0] t]
        set lastTime [lindex [lindex $existingTrail end] 0]
        if {$now - $lastTime < 200} {
            return
        }
    } else {
        set existingTrail [list]
    }

    # Add current position with timestamp and color
    lappend existingTrail [list $now $quad $color]

    # Keep last 8 positions
    if {[llength $existingTrail] > 8} {
        set existingTrail [lrange $existingTrail end-7 end]
    }

    puts "TRACE: Storing trail for tag $tagId with [llength $existingTrail] positions"
    Hold! -keep 2000ms -key [list trace-trail $tagId] \
        Claim tag $tagId has trail $existingTrail
}

# Draw the trail
When display /disp/ has width /displayWidth/ height /displayHeight/ &\
     display /disp/ has intrinsics /displayIntrinsics/ &\
     the quad library is /quadLib/ &\
     the quad changer is /quadChange/ &\
     the pose library is /poseLib/ &\
     tag /tagId/ has trail /trail/ {

    puts "TRACE: Drawing trail for tag $tagId with [llength $trail] positions"
    if {[llength $trail] < 2} {
        puts "TRACE: Not enough points yet"
        return
    }

    fn quadChange

    # Draw ghost tag outlines for each trail position (excluding current)
    set trailToDraw [lrange $trail 0 end-1]
    foreach entry $trailToDraw {
        lassign $entry timestamp quad color

        # Convert quad to display space
        set displayQuad [quadChange $quad "display $disp"]

        # Project quad vertices to 2D screen coordinates
        set screenVerts [lmap v [$quadLib vertices $displayQuad] {
            $poseLib project $displayIntrinsics \
                $displayWidth $displayHeight $v
        }]

        # Close the rectangle
        lappend screenVerts [lindex $screenVerts 0]

        # Draw outline with same color as when it was recorded
        Wish to draw a line onto $disp with \
            points $screenVerts width 2 color $color
    }
}
